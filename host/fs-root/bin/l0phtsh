#! /bin/bash -r

# This is called by SSHD inside L0PHT-HOST docker.
# Find out if SSHD allocated a TTY
# - Redirects not allowed in restricted shells.
# - Execute `tty' in unrestricted shell (one day a clever hacker will exploit this)
# - Set docker arguments if this is a TTY session.
bash -c "tty >/dev/null" && { ARG="-it"; PARAM=("-il"); } || { ARG="-i"; PARAM=(); }

# Connect to existing session
[[ -n $LID ]] && [[ ${#LID} -eq 12 ]] && {
	docker exec -it "lg-${LID}" zsh "${PARAM[@]}" "$@" || { echo "SESSION GONE"; exit 255; }
}

LID="$(head -c 1024 /dev/urandom | tr -dc '[:alpha:]' | head -c 12)"
HID="$(head -c 1024 /dev/urandom | tr -dc '[:alpha:]' | head -c 6)"
LVER="1.1"
docker run \
	--hostname "l0pht-${HID}" \
	--rm \
	"$ARG" \
	--name "lg-${LID}" \
	--init \
	--net l0pht_guest-net \
	--dns 172.24.0.2 \
	--env LID="${LID}" \
	--env LVER="${LVER}" \
	--log-driver none \
	-v "l0pht_guest-data:/usr/local/l0pht-guest:ro" \
	l0pht-guest zsh "${PARAM[@]}" "$@"

